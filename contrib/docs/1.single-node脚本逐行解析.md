# single-node.sh 脚本逐行解析

## 脚本概述
这个脚本用于启动一个单节点的 Gaia 测试网络，包含完整的初始化、配置和启动过程。

---

## 逐行详细解析

### 第1行：Shebang声明
```bash
#!/bin/sh
```
- **作用**：指定脚本解释器为 `/bin/sh`
- **说明**：告诉系统使用 sh shell 来执行这个脚本

### 第2行：空行
```bash

```
- **作用**：代码格式化，增加可读性

### 第3行：错误处理设置
```bash
set -o errexit -o nounset
```
- **`set -o errexit`**：如果任何命令返回非零退出状态，脚本立即退出
- **`set -o nounset`**：如果使用未定义的变量，脚本立即退出
- **作用**：提高脚本的健壮性，防止错误传播

### 第5行：设置主目录变量
```bash
HOME_DIR="${1:-$HOME}"
```
- **`${1:-$HOME}`**：参数扩展语法
  - 如果脚本有第一个参数 `$1`，使用 `$1`
  - 如果没有第一个参数，使用默认值 `$HOME`
- **作用**：允许用户指定自定义主目录，否则使用系统默认主目录

### 第6行：设置链ID
```bash
CHAINID="test-gaia"
```
- **作用**：定义区块链网络的唯一标识符
- **值**：`test-gaia` - 测试网络的链ID

### 第7行：设置用户初始代币
```bash
USER_COINS="100000000000stake"
```
- **作用**：定义创世账户的初始代币数量
- **值**：1000亿个 stake 代币（基础单位）

### 第8行：设置质押金额
```bash
STAKE="100000000stake"
```
- **作用**：定义验证者的初始质押金额
- **值**：1亿个 stake 代币

### 第9行：设置节点名称
```bash
MONIKER="gaia-test-node"
```
- **作用**：定义节点的显示名称/别名
- **值**：`gaia-test-node`

### 第10行：设置可执行文件名
```bash
GAIAD="gaiad"
```
- **作用**：定义 Gaia 守护进程的可执行文件名
- **说明**：可以通过修改这个变量来使用不同路径的 gaiad

### 第13行：显示使用的主目录
```bash
echo "Using home dir: $HOME_DIR"
```
- **作用**：输出当前使用的主目录路径
- **用途**：调试和确认配置

### 第14行：清理旧数据
```bash
rm -rf $HOME_DIR/.gaia
```
- **`rm -rf`**：强制递归删除
- **作用**：删除之前的 Gaia 数据目录，确保干净启动
- **路径**：`$HOME_DIR/.gaia` - Gaia 的默认数据目录

### 第15行：初始化节点
```bash
$GAIAD init --chain-id $CHAINID $MONIKER --home "$HOME_DIR/.gaia"
```
- **`$GAIAD init`**：初始化 Gaia 节点
- **`--chain-id $CHAINID`**：指定链ID为 `test-gaia`
- **`$MONIKER`**：节点名称为 `gaia-test-node`
- **`--home "$HOME_DIR/.gaia"`**：指定数据目录
- **作用**：创建节点配置文件和创世文件

### 第17行：提示信息
```bash
echo "Setting up genesis file"
```
- **作用**：输出当前操作的提示信息

### 第18-20行：修改创世文件参数
```bash
jq ".app_state.gov.params.voting_period = \"20s\" | .app_state.gov.params.expedited_voting_period = \"10s\" | .app_state.staking.params.unbonding_time = \"86400s\"" \
   "${HOME_DIR}/.gaia/config/genesis.json" > \
   "${HOME_DIR}/edited_genesis.json" && mv "${HOME_DIR}/edited_genesis.json" "${HOME_DIR}/.gaia/config/genesis.json"
```
- **`jq`**：JSON 处理工具
- **修改的参数**：
  - `voting_period = "20s"`：治理提案投票期为20秒
  - `expedited_voting_period = "10s"`：快速提案投票期为10秒
  - `unbonding_time = "86400s"`：解绑时间为24小时（86400秒）
- **操作流程**：读取创世文件 → 修改参数 → 写入临时文件 → 替换原文件

### 第22行：创建验证者密钥
```bash
$GAIAD keys add validator --keyring-backend="test"
```
- **`keys add validator`**：创建名为 "validator" 的密钥
- **`--keyring-backend="test"`**：使用测试密钥环（不需要密码）
- **作用**：生成验证者账户的公私钥对

### 第23行：创建用户密钥
```bash
$GAIAD keys add user --keyring-backend="test"
```
- **`keys add user`**：创建名为 "user" 的密钥
- **作用**：生成普通用户账户的公私钥对

### 第24行：添加验证者创世账户
```bash
$GAIAD genesis add-genesis-account $("${GAIAD}" keys show validator -a --keyring-backend="test") $USER_COINS
```
- **`$("${GAIAD}" keys show validator -a --keyring-backend="test")`**：命令替换，获取验证者地址
- **`genesis add-genesis-account`**：在创世文件中添加账户
- **`$USER_COINS`**：分配1000亿个 stake 代币

### 第25行：添加用户创世账户
```bash
$GAIAD genesis add-genesis-account $("${GAIAD}" keys show user -a --keyring-backend="test") $USER_COINS
```
- **作用**：为普通用户账户分配初始代币

### 第26行：生成创世交易
```bash
$GAIAD genesis gentx validator $STAKE --keyring-backend="test" --chain-id $CHAINID
```
- **`genesis gentx`**：生成创世交易（genesis transaction）
- **`validator`**：使用验证者密钥签名
- **`$STAKE`**：质押1亿个 stake 代币
- **作用**：创建验证者的初始质押交易

### 第27行：收集创世交易
```bash
$GAIAD genesis collect-gentxs
```
- **作用**：收集所有创世交易并添加到创世文件中
- **说明**：完成创世文件的最终配置

### 第29行：配置提示
```bash
# Set proper defaults and change ports
```
- **作用**：注释，说明接下来要设置默认值和端口

### 第30行：配置提示
```bash
echo "Setting up node configs"
```
- **作用**：输出配置节点的提示信息

### 第31行：注释掉的端口配置
```bash
# sed -i '' 's#"tcp://127.0.0.1:26657"#"tcp://0.0.0.0:26657"#g' ~/.gaia/config/config.toml
```
- **作用**：被注释的代码，原本用于修改RPC监听地址
- **说明**：从本地监听改为所有接口监听

### 第32行：等待
```bash
sleep 1
```
- **作用**：暂停1秒，确保文件操作完成

### 第33行：修改提交超时
```bash
sed -i -r 's/timeout_commit = "5s"/timeout_commit = "1s"/g' ~/.gaia/config/config.toml
```
- **`sed -i -r`**：就地编辑文件，使用扩展正则表达式
- **作用**：将区块提交超时从5秒改为1秒，加快出块速度

### 第34行：修改提案超时
```bash
sed -i -r 's/timeout_propose = "3s"/timeout_propose = "1s"/g' ~/.gaia/config/config.toml
```
- **作用**：将区块提案超时从3秒改为1秒

### 第35行：启用索引
```bash
sed -i -r 's/index_all_keys = false/index_all_keys = true/g' ~/.gaia/config/config.toml
```
- **作用**：启用所有键的索引，提高查询性能

### 第36行：设置最低gas价格
```bash
sed -i -r 's/minimum-gas-prices = ""/minimum-gas-prices = "0stake"/g' ~/.gaia/config/app.toml
```
- **作用**：设置最低gas价格为0stake，允许免费交易（测试环境）

### 第38行：启动提示
```bash
# Start the gaia
```
- **作用**：注释，说明要启动Gaia节点

### 第39行：启动节点
```bash
$GAIAD start --api.enable=true
```
- **`$GAIAD start`**：启动Gaia守护进程
- **`--api.enable=true`**：启用REST API服务
- **作用**：启动区块链节点，开始出块和处理交易
---

## 总结

这个脚本完成了以下主要任务：
1. **环境准备**：设置变量和错误处理
2. **数据清理**：删除旧的节点数据
3. **节点初始化**：创建配置文件和创世文件
4. **创世配置**：修改治理和质押参数
5. **账户创建**：生成验证者和用户密钥
6. **创世账户**：在创世文件中添加初始账户和余额
7. **验证者设置**：创建初始验证者
8. **性能优化**：调整超时参数和启用索引
9. **节点启动**：启动区块链节点并启用API

整个过程创建了一个完整的单节点测试网络，适合开发和测试使用。